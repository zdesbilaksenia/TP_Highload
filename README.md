# Tinder

## 1. Тема и целевая аудитория

### MVP

1. Создание и редактирование профиля
1. Персональные рекомендации
1. Система "лайков" и "пропусков" других пользователей
1. Межпользовательские чаты

### Целевая аудитория

Всего активных пользователей: 75 млн. Число новых пользователей каждый месяц: 6.2 млн. Tinder доступен в 190 странах и
более чем на 40 языках.

| Населенный пункт  |  Кол-во пользователей (млн) |
| ------------ | ------------ |
|  США |  8 |
| Великобритания  | 5  |
|  Бразилия | 10  |
|  Европа | 30  |
|  Канада |  4 |
|  Россия | 5  |
|  Остальные страны |  12 |

## 2. Расчет нагрузки

### Продуктовые метрики

1. Среднее число активных пользователей в месяц: 66 млн
2. Среднее число активных пользователей в день: 12 млн
3. Средний размер хранилища пользователя:

| Параметр | Размер  |
| ------------ | ------------ |
| Фотографии пользователя (в среднем 3 шт) | 1.5 Мб  |
|  Чаты пользователя | 2 Мб  |
|  Данные профиля  | 1 Мб  |
|  Итого | 4.5 Мб  |

4. Среднее количество действий пользователей ежедневно

| Параметр | Количество  |
| ------------ | ------------ |
| Использование сервиса за день | 90 мин  |
| Создание профиля | 100 000  |
| Редактирование профиля | 60 000  |
|  Просматриваемые страницы | 10 шт.  |
|  Свайпы | 400 млн  |
|  Сообщения  | 30 млн  |
|  Посещения  | 2 млрд  |
|  Мэтчи  | 3 млн |

### Технические метрики

1. Размер хранения в разбивке по типам данных (в Тб):
    - для фотографий: 150 Тб
    - для сообщений: 100 Тб

2. Сетевой трафик:

В день пользователь просматривает около 10 страниц. При просмотре страницы происходит запрос за фотографией и
информацией о просматриваемом человеке. Итого дневной трафик:

фотографии - ` 12e6 * 10 * 1.5 = 180 Мб/сутки ≈ 200 000 Гб/сутки`

данные о пользователях - `12e6 * 10 * 1 ≈ 120 000 Гб/сутки`

При возникновении мэтча между пользователями открывается чат. Если предположить, что пользователь пишет в среднем 20
сообщений и вес одного сообщения около 3 Кб, то в день на чаты тратится:

`3e6 * 2 * 20 * 3 = 360 000 000 Кб/сутки ≈ 350 Гб/сутки`

Пиковая нагрузка приходится на время с 18:00 до 22:00. Предположим, что в это время сервисом пользуются 50% (6 млн)
пользователей, тогда пиковое потребление:

фотографии - `6e6 * 10 * 1.5 / 4 = 22 500 000 Мб/ч ≈ 50 Гбит/с`

данные о пользователях - `6e6 * 10 * 1 / 4 = 15 000 000 Мб/ч ≈ 33 Гбит/с`

Больше всего мэтчей приходится именно на время пиковой нагрузки => на сообщения тратится меньше 1 Гбит/с.

3. RPS

|  Запросы | RPS  |
| ------------ | ------------ |
|  Загрузка профиля | 400e6 / 24 / 60 / 60 ≈ 4630   |
|  Создание и редактирование профиля  |  (100e3 + 60e3) / 24 / 60 / 60 ≈ 2    |
|  Мэтчи (на запись)  |  3e6 / 24 / 60 / 60 ≈ 35  |
|  Мэтчи (на чтение для составления рекомендаций)  | 12e6 / 24 / 60 / 60) ≈ 139  |
|  Чаты (на запись)  |  3e6 / 24 / 60 / 60 ≈ 35  |
|  Чаты (на чтение)  |  12e6 / 24 / 60 / 60 ≈ 139  |
|  Сообщения (на запись)  |  3e6 * 2 / 24 / 60 / 60 ≈ 70  |
|  Фотографии (на чтение)  |  400e6 * 3 / 24 / 60 / 60 ≈ 13889   |

## 3. Логическая схема

![alt text](https://s1.hostingkartinok.com/uploads/images/2022/05/e56c903daa94b39d68851eb7efb85a75.jpg)

## 4. Физическая схема
![alt text](https://s1.hostingkartinok.com/uploads/images/2022/05/3938866a795ae9c9b42229772b4dbe97.jpg)
### Таблицы

Users

| Переменная      | Тип               | Размер |
|-----------------|-------------------|--------|
| id              | bigint            | 8      |
| name            | varchar(50)       | 50     |
| age             | varchar(20)       | 20     |
| city            | varchar(20)       | 20     |
| gender          | varchar(20)       | 20     |
| social accounts | array[varchar(50] | 250    |
| status          | varchar(20)       | 20     |

Sessions

| Name            | Тип         | Размер |
|-----------------|-------------|--------|
| id              | bigint      | 8      |
| user            | bigint      | 8      |
| token           | varchar(64) | 64     |

Photos

| Name    | Тип | Размер |
|---------| --- | --- |
| id      | bigint | 8 |
| user    | bigint | 8 |
| link | varchar(256)  | 256 |

Matches

| Переменная  | Тип | Размер |
|-------------| --- | --- |
| id          | bigint | 8 |
| first_user  | bigint | 8 |
| second_user | bigint | 8 |

Messages

| Переменная  | Тип | Размер |
|-------------| --- | --- |
| id          | bigint | 8 |
| first_user  | bigint | 8 |
| second_user | bigint | 8 |
| text        | text | 256 |
| time        | timestamp | 8 |
| status      | boolean | 1 |

Swipes

| Переменная  | Тип | Размер |
|-------------| --- | --- |
| id          | bigint | 8 |
| first_user  | bigint | 8 |
| second_user | bigint | 8 |
| like        | boolearn | 1 |

### Базы данных

PostgreSQL: Users, Photos, Messages. Выбрана как наиболее надежная и популярная реляционная БД.

Redis: Sessions, Swipes, Matches. Выбрана из-за высокой скорости работы.

Amazon S3: хранение фотографий. Выбрана из-за высокой надежности, доступности, производительности и безопасности в
отрасли хранения изображений.

### Схема шардинга

Использоваться будет master-slave репликация - по 2 реплики на сервер.

Схема работы: мастер принимает запросы на запись, реплики - на чтение, при выходе из строя мастера одна из реплик
возьмет на себя запросы на запись, при выходе из строя всех реплик запросы будут приходить только на мастер.

| Таблица  |    СУБД     | Шардинг по |
|----------|:-----------:|:----------:|
| Users    | PostgreSQL  |     id     |
| Photos   | PostgreSQL  |    user    |
| Sessions |    Redis    |    user    |
| Swipes   |    Redis    | first_user |
| Matches  |    Redis    |     id     |
| Messages | PostgresSQL | first_user |

## 5. Технологии

Backend: Golang. Менеджер зависимистей (go.mod), большое количество библиотек, эффективная многопоточность (горутины),
микросервисная архитектура, протокол взаимодействий - gRPC.

Frontend: Typescript + React, наличие статической типизации, нахождение ошибок в коде до сборки, React поддерживает
Virtual DOM, сборщик модулей - Webpack, балансировщик - nginx.

Mobile: Android - Kotlin, IOS - Swift.

## 6. Схема проекта

![alt text](https://s1.hostingkartinok.com/uploads/images/2022/05/35a2b065f00b5c7e420506a93bb44847.jpeg)

## 7. Список серверов

| Сущность   |CPU (ядра)|RAM (ГБ)| Хранилище (SSD или HDD) |                                                                                                  Количество (masters+slaves)                                                                                                  |
|------------| :-------------:  | :-------------:  |:-----------------------:|:-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------:|
| PostgreSQL |32|128|       HDD: 64 Тб        |                                             Для пользователей с ссылками на фотографиями: 75e6 / 1024^2 / 10 ≈ 1<br/> Для сообщений: 100 / 64 ≈ 2<br/>Итого: 3 masters (6 slaves)                                             |
| Redis      |32|128|       SSD: 256 Гб       | Для сессий: (8 + 8 + 64) * 66e6 / 1024^3 / 256 ≈ 1<br/>Для свайпов: (8 + 8 + 8 + 1) * 400e6 * 30 / 1024^3 / 256 ≈ 1<br/>Для мэтчей: (8 + 8 + 8) * 3e6 * 30 / 1024^3 / 256 << 1 <br/> Итого на месяц: 2-3 masters (4-6 slaves) |

Nginx

| CPU | RAM | SSD |
| --- | --- | --- |
| 128 | 64 Gb | 128 Gb |

Golang-Backend

| CPU | RAM | SSD |
| --- | --- | --- |
| 64 | 64 Gb | 128 Gb |

Ссылки: https://www.businessofapps.com/data/tinder-statistics/
https://hookupdate.net/tinder-statistics/  
https://www.reuters.com/article/us-match-group-results-idUSKBN2A22V1 https://datingzest.com/tinder-statistics/
